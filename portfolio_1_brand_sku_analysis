import pandas as pd
import matplotlib.pyplot as plt

# Загрузка данных
df = pd.read_csv('data_sales.csv',sep=';')

# Просмотр первых строк данных
df.head()

# Добавим колонку с выручкой
df['revenue'] = df['SALE_SUM'] * df['QUANTITY']

# Добавим колонку с маржой
df['margin']=df['SALE_SUM']-df['COST_SUM_WO_TAX']-df['TAX']

# Добавим колонку с маржинальностьюм
df['marginality']=df['margin']/(df['SALE_SUM']-df['TAX'])*100

# Группировка по брендам
brand_revenue = df.groupby('BRAND').agg(
    TOTAL_REV=('revenue', 'sum'),
    AVG_MARGINALITY=('marginality', 'mean')
)

brand_revenue_starts=brand_revenue.sort_values('TOTAL_REV', ascending=False)

brand_revenue_top5=brand_revenue_starts.head(5)

brand_margin_starts=brand_revenue.sort_values('AVG_MARGINALITY', ascending=False).head(1)

# Группировка по SKU
sku_revenue = df.groupby('SKU').agg(
    TOTAL_REV_S=('revenue', 'sum'),
    AVG_MARGINALITY_S=('marginality', 'mean')
)

sku_revenue_starts=sku_revenue.sort_values('TOTAL_REV_S', ascending=False)

sku_marginality_1=sku_revenue.sort_values('AVG_MARGINALITY_S', ascending=False).head(1)

# Визуализация
plt.figure(figsize=(12, 4))
plt.subplot(1, 3, 1)
brand_revenue_top5['TOTAL_REV'].plot(kind='bar', color=['blue', 'green', 'red', 'purple', 'orange'], alpha=0.7, edgecolor='black')
plt.title('Топ 5 брендов по выручке за месяц')
plt.xlabel('Бренды')
plt.ylabel('Выручка,млн руб')
plt.xticks(rotation=45)
plt.show()

print("Товар с высокой выручкой")
print(sku_revenue_starts.head(1), "\n")

print("Товар с высокой маржинальностью")
print(sku_marginality_1)

print("Бренд с высокой маржинальностью")
print(brand_margin_starts)
